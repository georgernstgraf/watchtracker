<!-- #watch-details.hbs -->
<div id="watchDetails"
     x-data="{
         editing: false,
         selectedImageFile: null,
         imagePreview: null,
         imageError: '',
         init() {
             $watch('selectedImageFile', (file) => {
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         const img = new Image();
                         img.onload = () => {
                             const tolerance = 0.01;
                             const ratio = img.width / img.height;
                             if (Math.abs(ratio - 1) > tolerance) {
                                 this.imageError = 'Image must be square. Got ' + img.width + 'x' + img.height;
                                 this.selectedImageFile = null;
                                 this.imagePreview = null;
                                 this.$refs.imageInput.value = '';
                             } else {
                                 this.imageError = '';
                                 this.imagePreview = e.target.result;
                             }
                         };
                         img.src = e.target.result;
                     };
                     reader.readAsDataURL(file);
                 }
             });
         },
         clearImagePreview() {
             this.selectedImageFile = null;
             this.imagePreview = null;
             this.imageError = '';
             this.$refs.imageInput.value = '';
         },
         toggleEdit(show) {
             this.editing = show;
             if (!show) {
                 this.clearImagePreview();
             }
         },
         async saveDetails() {
             const form = this.$refs.watchForm;
             const formData = new FormData(form);
             if (this.selectedImageFile) {
                 formData.set('image', this.selectedImageFile);
             }
             try {
                 const response = await fetch(form.getAttribute('hx-patch'), {
                     method: 'PATCH',
                     body: formData
                 });
                 if (response.ok) {
                     const html = await response.text();
                     const mainContent = document.getElementById('mainContent');
                     mainContent.innerHTML = html;
                     mainContent.querySelectorAll('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete]').forEach(el => {
                         htmx.process(el);
                     });
                 } else {
                     const error = await response.text();
                     this.imageError = error || 'Failed to save';
                 }
             } catch (err) {
                 this.imageError = 'Error: ' + err.message;
             }
         }
     }">
    <!-- Back Button -->
    <div class="mb-3">
        <button class="btn btn-outline-light btn-sm"
                hx-get='{{appPath}}/auth/watches'
                hx-target='#mainContent'
                hx-swap='innerHTML'>
            ← Back to Watches
        </button>
    </div>

    <div class="row g-3">
        <!-- Left Column: Watch Image (sticky on desktop) -->
        <div class="col-12 col-md-5 col-lg-5">
            <div class="position-sticky top-0 pt-2">
                <!-- Normal View -->
                <div x-show="!editing">
                    {{#if watch.image}}
                    <img src="data:image/jpeg;base64,{{toBase64 watch.image}}"
                         class="img-fluid w-100"
                         alt="{{watch.name}}"
                         style="max-height: 90vh; object-fit: cover; -webkit-mask-image: radial-gradient(circle, black 50%, transparent 71%); mask-image: radial-gradient(circle, black 50%, transparent 71%);">
                    {{else}}
                    <div class="d-flex align-items-center justify-content-center"
                         style="max-height: 90vh; aspect-ratio: 1/1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-mask-image: radial-gradient(circle, black 50%, transparent 71%); mask-image: radial-gradient(circle, black 50%, transparent 71%);">
                        <span class="display-1 text-white fw-bold">{{getInitials watch.name}}</span>
                    </div>
                    {{/if}}
                </div>
                <!-- Edit View -->
                <div x-show="editing" x-cloak>
                    <div class="ratio ratio-1x1">
                        <div class="d-flex align-items-center justify-content-center bg-secondary rounded">
                            <template x-if="!imagePreview">
                                <span class="text-muted">No image selected</span>
                            </template>
                            <template x-if="imagePreview">
                                <img :src="imagePreview" alt="Preview" class="w-100 h-100 rounded" style="object-fit: cover;">
                            </template>
                        </div>
                    </div>
                    <input type="file"
                           x-ref="imageInput"
                           accept="image/jpeg,image/png,image/webp"
                           class="d-none"
                           @change="selectedImageFile = $event.target.files[0]">
                    <div class="mt-2 text-center">
                        <button type="button"
                                class="btn btn-outline-light btn-sm"
                                @click="$refs.imageInput.click()">
                            Choose Image
                        </button>
                        <button type="button"
                                class="btn btn-outline-warning btn-sm ms-1"
                                x-show="imagePreview"
                                @click="clearImagePreview()">
                            Clear
                        </button>
                    </div>
                    <small class="text-muted d-block text-center mt-1">Square image required</small>
                </div>
            </div>
        </div>

        <!-- Right Column: Watch Info + Measurements -->
        <div class="col-12 col-md-7 col-lg-7">
            <!-- Watch Name/Comment Card -->
            <div class="card bg-dark border-secondary mb-3" x-show="!editing">
                <div class="card-body py-2">
                    <h5 class="card-title text-light mb-0">{{watch.name}}</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{#if watch.comment}}
                        <small class="text-muted">{{watch.comment}}</small>
                        {{/if}}
                        {{#if watch.overallMeasure}}
                        <small class="text-muted">{{watch.overallMeasure.durationDays}} days</small>
                        <small class="text-muted">· {{watch.overallMeasure.niceDisplay}}</small>
                        {{/if}}
                        <button class="btn btn-outline-light btn-sm ms-auto py-0 px-1"
                                @click="toggleEdit(true)"
                                title="Edit Name, Comment and Image">
                            ✏️
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Card -->
            <div class="card bg-dark border-secondary mb-3" x-show="editing" x-cloak>
                <div class="card-body">
                    <form x-ref="watchForm"
                          hx-patch="{{appPath}}/auth/watch/{{watch.id}}"
                          hx-encoding="multipart/form-data"
                          hx-trigger="trigger"
                          hx-target="#mainContent"
                          hx-swap="innerHTML">
                        <input type="text"
                               name="name"
                               value="{{watch.name}}"
                               class="form-control form-control-sm bg-dark text-light border-light mb-2">
                        <input type="text"
                               name="comment"
                               {{#if watch.comment}}
                               value="{{watch.comment}}"
                               {{else}}
                               placeholder="Enter comment"
                               {{/if}}
                               class="form-control form-control-sm bg-dark text-light border-light mb-2">
                    </form>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light"
                                title="Cancel Edit"
                                @click="toggleEdit(false)">Cancel</button>
                        <button class="btn btn-outline-light"
                                title="Save"
                                @click="saveDetails()">Save</button>
                    </div>
                    <div x-show="imageError" class="alert alert-danger mt-2 py-1" x-text="imageError"></div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div id="measurements">
                {{> measurements}}
            </div>
        </div>
    </div>
</div>
<!-- /watch-details.hbs -->
