<!-- fragments/watch-details.hbs -->
<div id="watchDetails"
     x-data="{
         isNew: {{#if watch.id}}false{{else}}true{{/if}},
         editing: {{#if watch.id}}false{{else}}true{{/if}},
         selectedImageFile: null,
          imagePreview: {{#if watch.image}}'{{appPath}}/watch/image/{{watch.id}}'{{else}}null{{/if}},
         imageCleared: false,
         imageError: '',
         init() {
             $watch('selectedImageFile', (file) => {
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         const img = new Image();
                         img.onload = () => {
                             const tolerance = 0.01;
                             const ratio = img.width / img.height;
                             if (Math.abs(ratio - 1) > tolerance) {
                                 this.imageError = 'Image must be square. Got ' + img.width + 'x' + img.height;
                                 this.selectedImageFile = null;
                                 this.imagePreview = {{#if watch.image}}'{{appPath}}/watch/image/{{watch.id}}'{{else}}null{{/if}};
                                 this.imageCleared = false;
                                 this.$refs.imageInput.value = '';
                             } else {
                                 this.imageError = '';
                                 this.imagePreview = e.target.result;
                                 this.imageCleared = false;
                             }
                         };
                         img.src = e.target.result;
                     };
                     reader.readAsDataURL(file);
                 }
             });
         },
         clearImagePreview() {
             this.selectedImageFile = null;
             this.imagePreview = null;
             this.imageCleared = true;
             this.imageError = '';
             this.$refs.imageInput.value = '';
         },
         toggleEdit(show) {
             this.editing = show;
             if (!show) {
                 this.clearImagePreview();
             }
         },
         cancelEdit() {
             if (this.isNew) {
                 // For new watches, cancel goes back to the watch list
                 htmx.ajax('GET', '{{appPath}}/home', { target: '#mainContent', swap: 'innerHTML', pushUrl: '{{appPath}}' });
             } else {
                 this.toggleEdit(false);
             }
         },
          async saveDetails() {
              const form = this.$refs.watchForm;
              const formData = new FormData(form);
              if (this.selectedImageFile) {
                  formData.set('image', this.selectedImageFile);
              } else if (this.imageCleared) {
                  formData.set('clearImage', 'true');
              }
              const isCreating = this.isNew;
             const url = isCreating ? '{{appPath}}/watch' : '{{appPath}}/watch/{{watch.id}}';
             const method = isCreating ? 'POST' : 'PATCH';
             try {
                 const response = await fetch(url, {
                     method: method,
                     body: formData
                 });
                 if (response.ok) {
                     const html = await response.text();
                     const mainContent = document.getElementById('mainContent');
                     mainContent.innerHTML = html;
                     mainContent.querySelectorAll('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete]').forEach(el => {
                         htmx.process(el);
                     });
                 } else {
                     const error = await response.text();
                     this.imageError = error || 'Failed to save';
                 }
             } catch (err) {
                 this.imageError = 'Error: ' + err.message;
             }
         }
     }">
    <!-- Back Button (only for existing watches) -->
    <div class="mb-3" x-show="!isNew">
        <button class="btn btn-outline-secondary btn-sm"
                hx-get='{{appPath}}/home'
                hx-target='#mainContent'
                hx-swap='innerHTML'
                hx-push-url='{{appPath}}'>
            ← Back to Watches
        </button>
    </div>

    <div class="row g-3">
        <!-- Left Column: Watch Image (sticky on desktop) -->
        <div class="col-12 col-md-5 col-lg-5">
            <div class="position-sticky top-0 pt-2">
                <!-- Normal View -->
                <div x-show="!editing">
                    {{#if watch.image}}
                    <img src="{{appPath}}/watch/image/{{watch.id}}"
                         class="img-fluid w-100"
                         alt="{{watch.name}}"
                         style="max-height: 90vh; object-fit: cover; -webkit-mask-image: radial-gradient(circle, black 50%, transparent 71%); mask-image: radial-gradient(circle, black 50%, transparent 71%);">
                    {{else}}
                    <div class="d-flex align-items-center justify-content-center"
                         style="max-height: 90vh; aspect-ratio: 1/1; background: linear-gradient(135deg, var(--bs-secondary-bg) 0%, var(--bs-border-color) 100%); -webkit-mask-image: radial-gradient(circle, black 50%, transparent 71%); mask-image: radial-gradient(circle, black 50%, transparent 71%);">
                        <span class="display-1 text-white fw-bold">{{getInitials watch.name}}</span>
                    </div>
                    {{/if}}
                </div>
                <!-- Edit View -->
                <div x-show="editing" x-cloak>
                    <div class="ratio ratio-1x1">
                        <div class="d-flex align-items-center justify-content-center bg-secondary rounded">
                            <template x-if="!imagePreview">
                                <span class="text-muted">No image selected</span>
                            </template>
                            <template x-if="imagePreview">
                                <img :src="imagePreview" alt="Preview" class="w-100 h-100 rounded" style="object-fit: cover;">
                            </template>
                        </div>
                    </div>
                    <input type="file"
                           x-ref="imageInput"
                           accept="image/jpeg,image/png,image/webp"
                           class="d-none"
                           @change="selectedImageFile = $event.target.files[0]">
                    <div class="mt-2 text-center">
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                @click="$refs.imageInput.click()">
                            Choose Image
                        </button>
                        <button type="button"
                                class="btn btn-outline-warning btn-sm ms-1"
                                x-show="imagePreview"
                                @click="clearImagePreview()">
                            Clear
                        </button>
                    </div>
                    <small class="text-body-secondary d-block text-center mt-1">Square image required</small>
                </div>
            </div>
        </div>

        <!-- Right Column: Watch Info + Measurements -->
        <div class="col-12 col-md-7 col-lg-7">
            <!-- Watch Name/Comment Card -->
            <div class="card border-secondary mb-3" x-show="!editing">
                <div class="card-body py-2">
                    <h5 class="card-title mb-0">{{watch.name}}</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{#if watch.comment}}
                        <small class="text-body-secondary">{{watch.comment}}</small>
                        {{/if}}
                        {{#if watch.overallMeasure}}
                        <small class="text-body-secondary">{{watch.overallMeasure.durationDays}} days</small>
                        <small class="text-body-secondary">· {{watch.overallMeasure.niceDisplay}}</small>
                        {{/if}}
                        <button class="btn btn-outline-secondary btn-sm ms-auto py-0 px-1"
                                @click="toggleEdit(true)"
                                title="Edit Name, Comment and Image">
                            ✏️
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Card -->
            <div class="card border-secondary mb-3" x-show="editing" x-cloak>
                <div class="card-body">
                    <form x-ref="watchForm"
                          hx-encoding="multipart/form-data">
                        <input type="text"
                               name="name"
                               value="{{watch.name}}"
                               class="form-control form-control-sm mb-2">
                        <input type="text"
                               name="comment"
                               {{#if watch.comment}}
                               value="{{watch.comment}}"
                               {{else}}
                               placeholder="Enter comment"
                               {{/if}}
                               class="form-control form-control-sm mb-2">
                    </form>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-danger"
                                title="Delete Watch"
                                x-show="!isNew"
                                hx-delete="{{appPath}}/watch/{{watch.id}}"
                                hx-target="#mainContent"
                                hx-swap="innerHTML"
                                hx-confirm="Are you sure you want to delete this watch?"
                                onclick="event.preventDefault()">Delete</button>
                        <button class="btn btn-outline-secondary"
                                title="Cancel"
                                @click="cancelEdit()">Cancel</button>
                        <button class="btn btn-outline-secondary"
                                title="Save"
                                @click="saveDetails()">Save</button>
                    </div>
                    <div x-show="imageError" class="alert alert-danger mt-2 py-1" x-text="imageError"></div>
                </div>
            </div>

            <!-- Measurements Section -->
            {{> fragments/measurements}}
        </div>
    </div>
</div>
<!-- /fragments/watch-details.hbs -->
